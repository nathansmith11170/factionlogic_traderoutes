<?xml version="1.0" encoding="utf-8"?>
<mdscript name="LIB_trade_routes"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="md.xsd">
    <cues>
        <cue name="GlobalTradeRouteTables" namespace="static">
            <actions>

                <!-- 
                    The master table with UUID as key, structured as follows:
                    table[ {$UUID} = 
                        table[
                            {$'BuyerSector'} = a sector,
                            {$'SupplierSector'} = a sector,
                            {$'ContractedWare'} = a ware,
                            {$'ContractedAmount'} = an integer,
                        ]
                    ]
                -->
                <set_value name="$MasterTable" exact="table[]"/>

                <!--
                    The following table exists to facilitate the searching of routes by sector
                    Its contents are all the routes which are supplying the buyer in the key

                    table[ {$BuyerSector} = table[
                            {$SupplierSector} = table[
                                {$Ware} = UUID of route for ware between sectors
                            ]
                        ]
                    ]
                -->
                <set_value name="$TradeRouteLookupTableByBuyerSector" exact="table[]"/>

                <!--
                    The following table exists to facilitate the searching of routes by sector
                    Its contents are all the routes which are buying from the supplier in the key

                    table[ {$SupplierSector} = table[
                            {$BuyerSector} = table[
                                {$Ware} = UUID of route for ware between sectors
                            ]
                        ]
                    ]
                -->
                <set_value name="$TradeRouteLookupTableBySupplierSector" exact="table[]"/>

            </actions>
            <cues>

                <!-- add a route to the tables -->
                <library name="AddRoute" purpose="run_actions">
                    <params>
                        <param name="BuyerSector"/>
                        <param name="SupplierSector" />
                        <param name="ContractedWare" />
                        <param name="ContractedAmount" />
                    </params>
                    <actions>
                        <!-- include shared tables in run_actions context -->
                        <set_value name="$MasterTable" exact="md.LIB_trade_routes.GlobalTradeRouteTables.$MasterTable"/>
                        <set_value name="$TradeRouteLookupTableByBuyerSector" exact="md.LIB_trade_routes.GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector"/>
                        <set_value name="$TradeRouteLookupTableBySupplierSector" exact="md.LIB_trade_routes.GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector"/>

                        <!--
                            Check contraint:
                            Any sector can only have one UUID for any unique ware and supplier combination
                            Log error and do not alter tables if constraint is violated
                        -->
                        <do_if value="@$TradeRouteLookupTableByBuyerSector.{ $BuyerSector }.{ $ContractedWare }">
                            <debug_to_file directory="'FactionTradeRoutes'" name="'FactionTradeRoutes.log'" text="'Violated uniqueness constraint for route between Buyer: %s and Supplier: %s carrying Ware: %s'.[$BuyerSector.knownname, $SupplierSector.knownname, $ContractedWare.name]"/>
                            <return/>
                        </do_if>

                        <!--
                            Add up to four entries to $TradeRouteLookupTableByBuyerAndWare-one for each sector for each ware in the route-and one entry to $MasterTable
                        -->
                        <run_actions ref="md.LIB_uuid_gen.GenerateUUID" result="$UUID"/>

                        <!-- string keys must start with $, add prefix to UUID -->
                        <set_value name="$UUIDKey" exact="'$%s'.[$UUID]"/>

                        <set_value name="$MasterTable.{ $UUIDKey }" exact="table[ {'$BuyerSector'} = $BuyerSector, {'$SupplierSector'} = $SupplierSector, {'$ContractedWare'} = $ContractedWare, {'$ContractedAmount'} = $ContractedAmount ]"/>

                        <!-- Be sure tables exist before trying to set key-value pairs -->
                        <do_if value="$TradeRouteLookupTableByBuyerSector.keys.list.indexof.{$BuyerSector} == 0">
                            <set_value name="$TradeRouteLookupTableByBuyerSector.$BuyerSector" exact="table[]"/>
                        </do_if>
                        <do_if value="$TradeRouteLookupTableByBuyerSector.$BuyerSector.keys.list.indexof.{$SupplierSector} == 0">
                            <set_value name="$TradeRouteLookupTableByBuyerSector.$BuyerSector.$SupplierSector" exact="table[]"/>
                        </do_if>
                        <set_value name="$TradeRouteLookupTableByBuyerSector.$BuyerSector.$SupplierSector.{$ContractedWare}" exact="$UUIDKey"/>
                        
                        <!-- Be sure tables exist before trying to set key-value pairs -->
                        <do_if value="$TradeRouteLookupTableBySupplierSector.keys.list.indexof.{$SupplierSector} == 0">
                            <set_value name="$TradeRouteLookupTableBySupplierSector.$SupplierSector" exact="table[]"/>
                        </do_if>
                        <do_if value="$TradeRouteLookupTableBySupplierSector.$SupplierSector.keys.list.indexof.{$BuyerSector} == 0">
                            <set_value name="$TradeRouteLookupTableBySupplierSector.$SupplierSector.$BuyerSector" exact="table[]"/>
                        </do_if>
                        <set_value name="$TradeRouteLookupTableBySupplierSector.$SupplierSector.$BuyerSector.{$ContractedWare}" exact="$UUIDKey"/>

                        <!-- set shared tables from run_actions context -->
                        <set_value name="md.LIB_trade_routes.GlobalTradeRouteTables.$MasterTable" exact="$MasterTable"/>
                        <set_value name="md.LIB_trade_routes.GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector" exact="$TradeRouteLookupTableByBuyerSector"/>
                        <set_value name="md.LIB_trade_routes.GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector" exact="$TradeRouteLookupTableBySupplierSector"/>

                        <return value="$UUIDKey"/>

                    </actions>
                </library>

                <!-- route removal  -->
                <library name="RemoveRouteByUUID" purpose="run_actions">
                    <params>
                        <param name="UUID" comment="The UUID of the route to remove from the route manager"/>
                    </params>
                    <actions>
                        <set_value name="$BuyerSector" exact="GlobalTradeRouteTables.MasterTable.{ $UUID }.{ '$BuyerSector' }"/>
                        <set_value name="$SupplierSector" exact="GlobalTradeRouteTables.MasterTable.{ $UUID }.{ '$SupplierSector' }"/>
                        <set_value name="$ContractedWare" exact="GlobalTradeRouteTables.MasterTable.{ $UUID }.{ '$ContractedWare' }"/>
                        <remove_value name="GlobalTradeRouteTables.MasterTable.{ $UUID }"/>
                        <remove_value name="GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector.$BuyerSector.$SupplierSector.$ContractedWare"/>
                        <remove_value name="GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector.$SupplierSector.$BuyerSector.$ContractedWare"/>
                    </actions>
                </library>

                <!-- find trade routes given a ware and the destination sector -->
                <library name="GetRoutesByBuyerAndWare" purpose="run_actions">
                    <params>
                        <param name="BuyerSector" comment="The sector that is the buyer of the ware"/>
                        <param name="Ware" comment="The ware for search"/>
                    </params>
                    <actions>
                        <create_list name="$Routes"/>
                        <do_for_each name="$SupplierSector" in="GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector.$BuyerSector">
                            <do_for_each name="$ContractedWare" in="GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector.$BuyerSector.$SupplierSector">
                                <do_if value="$Ware == $ContractedWare">
                                    <append_to_list name="$Routes" exact="GlobalTradeRouteTables.MasterTable.{ GlobalTradeRouteTables.$TradeRouteLookupTableByBuyerSector.$BuyerSector.$SupplierSector.$ContractedWare }" />
                                </do_if>
                            </do_for_each>
                        </do_for_each>
                        <return value="$Routes"/>
                    </actions>
                </library>

                <!-- find trade routes given a ware and the supplier sector -->
                <library name="GetRoutesBySupplierAndWare" purpose="run_actions">
                    <params>
                        <param name="SupplierSector" comment="The sector that is the supplier of the ware"/>
                        <param name="Ware" comment="The ware for search"/>
                    </params>
                    <actions>
                        <create_list name="$Routes"/>
                        <do_for_each name="$BuyerSector" in="GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector.$SupplierSector">
                            <do_for_each name="$ContractedWare" in="GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector.$SupplierSector.$BuyerSector">
                                <do_if value="$Ware == $ContractedWare">
                                    <append_to_list name="$Routes" exact="GlobalTradeRouteTables.MasterTable.{ GlobalTradeRouteTables.$TradeRouteLookupTableBySupplierSector.$SupplierSector.$BuyerSector.$ContractedWare }" />
                                </do_if>
                            </do_for_each>
                        </do_for_each>
                        <return value="$Routes"/>
                    </actions>
                </library>

                <!-- find amount of ware already contracted for purchase, optionally only give amount imported from foreigners -->
                <library name="GetAmountContractedForPurchaseBySectorAndWare" purpose="run_actions">
                    <params>
                        <param name="BuyerSector" comment="The sector that is the buyer of the ware"/>
                        <param name="Ware" comment="The ware for search"/>
                        <param name="ForeignOnly" comment="boolean to search for only foreign contracts"/>
                    </params>
                    <actions>
                        <set_value name="$TotalContractedAmount" exact="0"/>

                        <run_actions ref="GetRoutesByBuyerAndWare" result="$TradeRoutes">
                            <param name="BuyerSector" value="$BuyerSector" />
                            <param name="Ware" value="$Ware" />
                        </run_actions>

                        <do_for_each name="$Route" in="$TradeRoutes">
                            <do_if value="$ForeignOnly">
                                <do_if value="$Route.{ '$SupplierSector' }.trueowner != $BuyerSector.trueowner">
                                    <set_value name="$TotalContractedAmount" exact="$Route.{ '$ContractedAmount' }" operation="add"/>
                                </do_if>
                            </do_if>
                            <do_else>
                                <set_value name="$TotalContractedAmount" exact="$Route.{ '$ContractedAmount' }" operation="add"/>
                            </do_else>
                        </do_for_each>

                        <return value="$TotalContractedAmount"/>
                    </actions>
                </library>

                <!-- find amount of ware already contracted for sale, optionally only give amount sold to foreigners -->
                <library name="GetAmountContractedForSaleBySectorAndWare" purpose="run_actions">
                    <params>
                        <param name="SupplierSector" comment="The sector that is the supplier of the ware"/>
                        <param name="Ware" comment="The ware for search"/>
                        <param name="ForeignOnly" comment="boolean to search for only foreign contracts"/>
                    </params>
                    <actions>
                        <set_value name="$TotalContractedAmount" exact="0"/>

                        <run_actions ref="GetRoutesBySupplierAndWare" result="$TradeRoutes">
                            <param name="SupplierSector" value="$SupplierSector" />
                            <param name="Ware" value="$Ware" />
                        </run_actions>

                        <do_for_each name="$Route" in="$TradeRoutes">
                            <do_if value="$ForeignOnly">
                                <do_if value="$Route.{ '$BuyerSector' }.trueowner != $SupplierSector.trueowner">
                                    <set_value name="$TotalContractedAmount" exact="$Route.{ '$ContractedAmount' }" operation="add"/>
                                </do_if>
                            </do_if>
                            <do_else>
                                <set_value name="$TotalContractedAmount" exact="$Route.{ '$ContractedAmount' }" operation="add"/>
                            </do_else>
                        </do_for_each>

                        <return value="$TotalContractedAmount"/>
                    </actions>
                </library>

                <!-- find trade route given its UUID -->
                <library name="FindRouteByUUID" purpose="run_actions">
                    <params>
                        <param name="UUID" comment="The uuid of the route we want"/>
                    </params>
                    <actions>
                        <return value="GlobalTradeRouteTables.MasterTable.{ $UUID }"/>
                    </actions>
                </library>

                <!-- make a csv file of trade routes -->
                <library name="DumpMasterTableToLog" purpose="run_actions">
                    <actions>

                        <debug_to_file directory="FactionTradeRoutes" name="'TradeRoutesDump%s.csv'.[player.age]" text="'%1, %2, %3, %4, %5, %6, %7\n'.['UUID', 'BuyerSector', 'SupplierSector', 'ContractedWare', 'ContractedAmount', 'WareMovedFromBToA', 'AmountMovedFromBToA']" />

                        <do_for_each name="$UUID" in="$GlobalTradeRouteTables.MasterTable.keys.list">
                            <debug_to_file directory="FactionTradeRoutes" name="'TradeRoutesDump%s.csv'.[player.age]" text="'%1, %2, %3, %4, %5, %6, %7\n'.[$UUID, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$BuyerSector' }.knownname, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$SupplierSector' }.knownname, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$ContractedWare' }.name, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$ContractedAmount' }, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$WareMovedFromBToA' }.name, $GlobalTradeRouteTables.MasterTable.$UUID.{ '$AmountMovedFromBToA' }]" />
                        </do_for_each>

                    </actions>
                </library>

            </cues>
        </cue>
    </cues>
</mdscript>
